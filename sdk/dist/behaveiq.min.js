!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.BqSdk=e():t.BqSdk=e()}(this,()=>(()=>{"use strict";var t={d:(e,i)=>{for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{default:()=>a});const i=class{async generate(){const t={canvas:await this.getCanvasFingerprint(),webgl:await this.getWebGLFingerprint(),audio:await this.getAudioFingerprint(),fonts:await this.getFontFingerprint()};return{hash:await this.hashComponents(t),components:t}}async getCanvasFingerprint(){const t=document.createElement("canvas"),e=t.getContext("2d");return t.width=200,t.height=50,e.textBaseline="top",e.font="14px Arial",e.fillStyle="#f60",e.fillRect(125,1,62,20),e.fillStyle="#069",e.fillText("BehaveIQ",2,15),e.fillStyle="rgba(102, 204, 0, 0.7)",e.fillRect(10,10,50,50),t.toDataURL()}async getWebGLFingerprint(){const t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");if(!e)return"not_supported";const i=e.getExtension("WEBGL_debug_renderer_info");if(!i)return"no_debug_info";return`${e.getParameter(i.UNMASKED_VENDOR_WEBGL)}~${e.getParameter(i.UNMASKED_RENDERER_WEBGL)}`}async getAudioFingerprint(){return new Promise(t=>{try{const e=window.AudioContext||window.webkitAudioContext;if(!e)return t("not_supported");const i=new e,s=i.createOscillator(),n=i.createAnalyser(),o=i.createGain(),a=i.createScriptProcessor(4096,1,1);o.gain.value=0,s.type="triangle",s.connect(n),n.connect(a),a.connect(o),o.connect(i.destination),a.onaudioprocess=function(e){const n=e.outputBuffer.getChannelData(0),o=Array.from(n).slice(0,30).reduce((t,e)=>t+e,0);s.disconnect(),a.disconnect(),i.close(),t(o.toString())},s.start(0)}catch(e){t("error")}})}async getFontFingerprint(){const t=["monospace","sans-serif","serif"],e=[],i="mmmmmmmmmmlli",s="72px",n=document.createElement("canvas").getContext("2d"),o={};return t.forEach(t=>{n.font=`${s} ${t}`,o[t]=n.measureText(i).width}),["Arial","Verdana","Times New Roman","Courier New","Georgia","Palatino","Garamond","Comic Sans MS"].forEach(a=>{let r=!1;t.forEach(t=>{n.font=`${s} ${a}, ${t}`;n.measureText(i).width!==o[t]&&(r=!0)}),r&&e.push(a)}),e}async hashComponents(t){const e=JSON.stringify(t),i=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(s)).map(t=>t.toString(16).padStart(2,"0")).join("")}};const s=class{constructor(t){this.sdk=t,this.mouseData=[],this.scrollData=[],this.clickData=[],this.cartActions=[],this.sessionStartTime=Date.now()}start(){this.trackPageView(),this.trackMouse(),this.trackScroll(),this.trackClicks(),this.trackCart()}trackPageView(){const t={url:window.location.href,timestamp:Date.now(),referrer:document.referrer};this.sdk.request("/behavior/track",{method:"POST",body:{userId:this.sdk.userId,sessionId:this.sdk.sessionId,eventType:"pageview",eventData:t}})}trackMouse(){let t=Date.now();document.addEventListener("mousemove",e=>{const i=Date.now();this.mouseData.push({x:e.clientX,y:e.clientY,timestamp:i}),this.mouseData.length>50&&this.mouseData.shift(),i-t>5e3&&(this.sendBehaviorData("mouse_move",{movements:this.mouseData.slice()}),t=i)})}trackScroll(){let t=Date.now();window.addEventListener("scroll",()=>{const e=Date.now(),i=(window.scrollY+window.innerHeight)/document.body.scrollHeight*100;this.scrollData.push({depth:Math.round(i),timestamp:e}),e-t>3e3&&(this.sendBehaviorData("scroll",{scrollData:this.scrollData.slice()}),t=e)})}trackClicks(){document.addEventListener("click",t=>{const e={element:t.target.tagName,id:t.target.id,class:t.target.className,x:t.clientX,y:t.clientY,timestamp:Date.now()};this.clickData.push(e),this.sendBehaviorData("click",e)})}trackCart(){document.addEventListener("click",t=>{const e=t.target;if(e.hasAttribute("data-cart-action")){const t=e.getAttribute("data-cart-action"),i={action:t,productId:e.getAttribute("data-product-id"),timestamp:Date.now()};this.cartActions.push(i),this.sendBehaviorData("cart_action",i),"view"===t&&this.cartActions.length>0&&this.checkAbandonmentRisk()}})}async checkAbandonmentRisk(){const t=Date.now()-this.cartActions[0].timestamp,e=await this.sdk.request("/abandonment/predict",{method:"POST",body:{userId:this.sdk.userId,sessionData:{sessionId:this.sdk.sessionId,cartDuration:t/1e3,scrollDepth:this.getMaxScrollDepth(),priceViewCount:this.countPriceViews(),productComparisons:this.cartActions.filter(t=>"view"===t.action).length,device:this.sdk.getDeviceInfo().type,cartValue:this.getCartValue()}}});e.success&&e.data.shouldIntervene}getMaxScrollDepth(){return this.scrollData.length>0?Math.max(...this.scrollData.map(t=>t.depth)):0}countPriceViews(){return this.clickData.filter(t=>t.class&&t.class.includes("price")).length}getCartValue(){return 0}sendBehaviorData(t,e){this.sdk.request("/behavior/track",{method:"POST",body:{userId:this.sdk.userId,sessionId:this.sdk.sessionId,eventType:t,eventData:e}}).catch(t=>{})}};const n=class{constructor(t){this.sdk=t,this.checkInterval=1e4}start(){setInterval(()=>this.analyzeEmotion(),this.checkInterval)}async analyzeEmotion(){const t={mouseMovements:this.sdk.tracker.mouseData,scrollData:this.sdk.tracker.scrollData,clickData:this.sdk.tracker.clickData,timeOnPage:Date.now()-this.sdk.sessionStartTime,currentPage:window.location.href},e=await this.sdk.request("/emotion/detect",{method:"POST",body:{userId:this.sdk.userId,sessionId:this.sdk.sessionId,behaviorData:t}});e.success&&"none"!==e.data.response.action&&this.showEmotionResponse(e.data)}showEmotionResponse(t){const{emotion:e,response:i}=t;"show_help_chat"===i.action?this.showHelpButton(i.message):"show_social_proof"===i.action?this.showSocialProof(i.urgencyMessage):"show_guide"===i.action&&this.showGuide(i.message)}showHelpButton(t){const e=document.createElement("div");e.id="behaveiq-help",e.innerHTML=`\n        <div style="position: fixed; bottom: 20px; right: 20px; \n                    background: #007bff; color: white; padding: 15px 20px;\n                    border-radius: 50px; cursor: pointer; z-index: 10000;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);">\n          ${t}\n        </div>\n      `,document.body.appendChild(e),setTimeout(()=>e.remove(),5e3)}showSocialProof(t){const e=document.createElement("div");e.id="behaveiq-social",e.innerHTML=`\n        <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%);\n                    background: #28a745; color: white; padding: 12px 24px;\n                    border-radius: 8px; z-index: 10000;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);">\n          ${t}\n        </div>\n      `,document.body.appendChild(e),setTimeout(()=>e.remove(),7e3)}showGuide(t){}};const o=class{constructor(t){if(this.sdk=t,this.recognition=null,this.isSupported="webkitSpeechRecognition"in window||"SpeechRecognition"in window,this.isSupported){const t=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new t,this.recognition.continuous=!1,this.recognition.lang="en-US"}}start(t){this.isSupported&&(this.recognition.start(),this.recognition.onresult=e=>{const i=e.results[0][0].transcript;this.searchByVoice(i,t)},this.recognition.onerror=t=>{})}async searchByVoice(t,e){const i=await this.sdk.request("/voice/search",{method:"POST",body:{query:t,userId:this.sdk.userId}});i.success&&e&&e(i.data.results)}};const a=class{constructor(t){t&&t.apiKey&&(this.apiUrl=t.apiUrl||"http://localhost:5000/api",this.apiKey=t.apiKey,this.userId=null,this.sessionId=null,this.fingerprint=null,this.sessionStartTime=Date.now(),this.fingerprintGenerator=new i,this.tracker=new s(this),this.emotionTracker=new n(this),this.voiceSearch=new o(this),this.init())}async init(){try{this.fingerprint=await this.fingerprintGenerator.generate(),await this.identifyUser(),this.tracker.start(),this.emotionTracker.start()}catch(t){}}async identifyUser(){const t=this.getDeviceInfo(),e=await this.getLocation(),i=await this.request("/identity/identify",{method:"POST",body:{fingerprint:this.fingerprint.hash,deviceInfo:t,fpComponents:this.fingerprint.components,location:e}});i.success&&(this.userId=i.data.userId,this.sessionId=i.data.sessionId,this.persona=i.data.persona)}getDeviceInfo(){const t=navigator.userAgent;return{type:this.getDeviceType(),os:this.getOS(),browser:this.getBrowser(),screenResolution:`${window.screen.width}x${window.screen.height}`,userAgent:t,language:navigator.language,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone}}getDeviceType(){const t=navigator.userAgent;return/mobile/i.test(t)?"mobile":/tablet|ipad/i.test(t)?"tablet":"desktop"}getOS(){const t=navigator.userAgent;return/windows/i.test(t)?"Windows":/mac/i.test(t)?"MacOS":/linux/i.test(t)?"Linux":/android/i.test(t)?"Android":/ios|iphone|ipad/i.test(t)?"iOS":"Unknown"}getBrowser(){const t=navigator.userAgent;return/chrome/i.test(t)&&!/edge/i.test(t)?"Chrome":/safari/i.test(t)&&!/chrome/i.test(t)?"Safari":/firefox/i.test(t)?"Firefox":/edge/i.test(t)?"Edge":"Unknown"}async getLocation(){try{const t=await fetch("https://ipapi.co/json/"),e=await t.json();return{ip:e.ip,country:e.country_name,city:e.city,coordinates:{lat:e.latitude,lng:e.longitude}}}catch(t){return null}}async request(t,e={}){const i=`${this.apiUrl}${t}`,s={method:e.method||"GET",headers:{"Content-Type":"application/json","X-API-Key":this.apiKey}};e.body&&(s.body=JSON.stringify(e.body));return(await fetch(i,s)).json()}};return e})());